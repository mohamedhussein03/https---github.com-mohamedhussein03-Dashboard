{% extends "dashboard/base.html" %}

{% block content %}

<div class="topbar">

    <!-- BP Card -->
    <div class="card bp-card">
        <div class="bp-header">
            <div class="bp-title">bp</div>
            <div class="bp-meta">
                <div class="bp-sub">BP Egypt</div>
                <div class="bp-sub">Live Monitor</div>
            </div>
        </div>

        <div class="bp-grid">
            <div>
                <span class="label">Location</span>
                <span class="value">Egypt (national operations)</span>
            </div>
            <div>
                <span class="label">Sector</span>
                <span class="value">Energy / Oil & Gas</span>
            </div>
            <div>
                <span class="label">Timezone</span>
                <span class="value">Africa/Cairo</span>
            </div>
            <div>
                <span class="label">Last updated</span>
                <span class="value">
                    {{ scenario.last_updated.strftime("%d %b %Y %H:%M") }}
                </span>
            </div>
        </div>
    </div>

    <!-- Incident Card -->
    <div class="card incident-card">

    <div class="incident-header">
        <h3>Incident</h3>
        <span class="incident-status">{{ scenario.status }}</span>
    </div>

    <div class="incident-title">
        {{ scenario.title }}
    </div>

    {% if scenario.window %}
        <div class="incident-window">
            {{ scenario.window }}
        </div>
    {% endif %}

    {% if scenario.description %}
        <div class="incident-description">
            {{ scenario.description }}
        </div>
    {% endif %}

</div>
    <!-- Live Clock -->
    <div class="card live-clock-card">
        <h3>Live Clock</h3>
        <div class="clock" id="liveClock">--:--</div>
    </div>


    <!-- Task Timer -->
    <div class="card timer-card">

        <div class="card-header">
            <h3>Task Timer</h3>
        </div>

        <div id="timerEmpty" class="empty">
            No active timer
        </div>

        <div id="timerActive" style="display:none;">
            <div class="timer-title" id="timerTitle"></div>
            <div class="timer-count" id="timerCountdown">00:00</div>
            <div class="timer-alert" id="timerAlert" style="display:none;">
                TIME EXPIRED
            </div>

            {% if is_admin %}
                <button class="btn danger small" onclick="clearTimer()">
                    Clear
                </button>
            {% endif %}
        </div>

        {% if is_admin %}
            <button class="btn primary small" onclick="openModal('timer')">
                Set Timer
            </button>
        {% endif %}

    </div>

</div>



<div class="card weather-card">

    <div class="weather-header">
        <h3>Weather</h3>

        {% if weather_items|length > 1 %}
            <div class="weather-nav">
                <button type="button" onclick="weatherPrev()">‹</button>
                <button type="button" onclick="weatherNext()">›</button>
            </div>
        {% endif %}
    </div>

    {% if weather_items %}

        <div id="weatherData" style="display:none;">
            {% for w in weather_items %}
                <div
                    data-temp="{{ w.temperature_c }}"
                    data-feels="{{ w.feels_like_c or '' }}"
                    data-humidity="{{ w.humidity or '' }}"
                    data-air="{{ w.air_quality or '' }}"
                    data-time="{{ w.created_at.strftime('%H:%M') }}">
                </div>
            {% endfor %}
        </div>

        <div class="weather-main">
            <div class="weather-temp" id="weatherTemp"></div>
            <div class="weather-feels" id="weatherFeels"></div>
        </div>

        <div class="weather-meta" id="weatherMeta"></div>

        <div class="weather-time" id="weatherTime"></div>

        {% if is_admin %}
            <button class="btn primary small" onclick="openModal('weather')">
                Add entry
            </button>
        {% endif %}

    {% else %}

        <div class="empty">No weather data</div>

        {% if is_admin %}
            <button class="btn primary small" onclick="openModal('weather')">
                Add
            </button>
        {% endif %}

    {% endif %}

</div>





<div class="ticker">
    <div class="tickerTop">
        <span class="liveDot"></span>
        <span>BREAKING / LIVE MONITOR</span>
    </div>

    <div class="tickerTrack">
        <div class="tickerContent">
            {% for item in breaking_items %}
                <span class="tickerItem">
                {{ item.title }}
                </span>
                {% else %}
                <span class="tickerItem">
                No high urgency updates
                </span>
            {% endfor %}
        </div>
    </div>
</div>

<div class="card heroCard">
    <div class="heroOverlay">
        <div class="kpis">
            <div class="kpi">
                <div class="n">{{ counts.social }}</div>
                <div class="l">Social</div>
            </div>
            <div class="kpi">
                <div class="n">{{ counts.rumors }}</div>
                <div class="l">Rumors</div>
            </div>
            <div class="kpi">
                <div class="n">{{ counts.news }}</div>
                <div class="l">News</div>
            </div>
            <div class="kpi">
                <div class="n">{{ counts.calls }}</div>
                <div class="l">Calls</div>
            </div>
            <div class="kpi">
                <div class="n">{{ counts.emails }}</div>
                <div class="l">Emails</div>
            </div>
        </div>
    </div>
</div>

<div class="main two-col">

 <!-- Social Monitor -->
<div class="card column-card">
    <div class="card-header">
        <div>
            <h3>Social Monitor</h3>
            <div class="sub">X / Facebook / IG / TikTok</div>
        </div>
        <div class="header-actions">
            <span class="badge">{{ counts.social }}</span>
            {% if is_admin %}
                <button class="btn primary" onclick="openModal('social')">+ Add</button>
            {% endif %}
        </div>
    </div>

    <div class="card-body scroll">
        {% for item in social_items %}
            <div class="feed-item"
                {% if is_admin %}
                    onclick="openSocialEditFromEl(this)"
                {% else %}
                    onclick="openSocialDetailFromEl(this)"
                {% endif %}
                data-id="{{ item.id }}"
                data-channel="{{ item.channel }}"
                data-region="{{ item.region }}"
                data-classification="{{ item.classification }}"
                data-urgency="{{ item.urgency }}"
                data-source="{{ item.source }}"
                data-title="{{ item.title }}"
                data-text="{{ item.text }}"
                data-tags="{{ item.tags or '' }}"
                data-image="{{ url_for('static', filename=item.image_path.replace('app/static/', '') ) if item.image_path else '' }}"
                data-time="{{ item.created_at.strftime('%H:%M') }}">

                {% if item.image_path %}
                    <img class="feed-thumb"
                         src="{{ url_for('static', filename=item.image_path.replace('app/static/', '') ) }}"
                         alt="">
                {% endif %}

                <div class="feed-meta">
                    <span class="source">
                        {{ item.classification|upper }} · {{ item.region|upper }} · {{ item.source }}
                    </span>
                    <span class="time">{{ item.created_at.strftime('%H:%M') }}</span>
                </div>

                <div class="feed-title">{{ item.title }}</div>
                <div class="feed-text">{{ item.text }}</div>

                <div class="feed-tags">
                    <span class="tag">{{ item.classification }}</span>
                    <span class="tag {{ item.urgency|lower }}">{{ item.urgency }}</span>
                    <span class="tag">{{ item.region }}</span>
                </div>

            </div>
        {% else %}
            <div class="empty">No social activity</div>
        {% endfor %}
    </div>
</div>

<!-- News & Headlines -->
<div class="card column-card">
    <div class="card-header">
        <div>
            <h3>News & Headlines</h3>
            <div class="sub">Local + international</div>
        </div>
        <div class="header-actions">
            <span class="badge">{{ counts.news }}</span>
            {% if is_admin %}
                <button class="btn primary" onclick="openModal('news')">+ Add</button>
            {% endif %}
        </div>
    </div>

    <div class="card-body scroll">
        {% for item in news_items %}
            <div class="feed-item"
                {% if is_admin %}
                    onclick="openNewsEditFromEl(this)"
                {% endif %}
                data-id="{{ item.id }}"
                data-source="{{ item.source }}"
                data-title="{{ item.title }}"
                data-text="{{ item.text }}"
                data-image="{{ url_for('static', filename=item.image_path.replace('app/static/', '') ) if item.image_path else '' }}">

                {% if item.image_path %}
                    <img class="feed-thumb"
                         src="{{ url_for('static', filename=item.image_path.replace('app/static/', '') ) }}"
                         alt="">
                {% endif %}

                <div class="feed-meta">
                    <span class="source">{{ item.source }}</span>
                    <span class="time">{{ item.created_at.strftime('%H:%M') }}</span>
                </div>

                <div class="feed-title">{{ item.title }}</div>
                <div class="feed-text">{{ item.text }}</div>

                <div class="feed-tags">
                    <span class="tag media">media</span>
                </div>

            </div>
        {% else %}
            <div class="empty">No headlines</div>
        {% endfor %}
    </div>
</div>


<!-- Latest Calls - FULL WIDTH -->
<div class="card calls-home-card">

    <div class="card-header">
        <h3>Latest Calls</h3>
        <span class="badge">{{ latest_calls|length }}</span>
    </div>

    {% if latest_calls %}
        <div class="calls-home-list">
            {% for call in latest_calls %}
                <div class="calls-home-item">
                    <div class="calls-home-top">
                        <span class="caller">{{ call.caller }}</span>
                        <span class="time">{{ call.created_at.strftime("%H:%M") }}</span>
                    </div>

                    <div class="calls-home-tags">
                        {% if call.urgency == "HIGH" %}
                            <span class="tag high">high</span>
                        {% endif %}
                        {% if call.is_media %}
                            <span class="tag media">media</span>
                        {% endif %}
                        {% if call.is_local %}
                            <span class="tag local">local</span>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="empty">No calls yet</div>
    {% endif %}

</div>



</div>

{% include "dashboard/modals.html" %}

{% endblock %}
