<!DOCTYPE html>
<html>
<head>
    <title>Crisis Dashboard</title>

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>

<div class="app-layout">

    <aside class="sidebar">

        <div class="sidebar-logo">
            <img src="{{ url_for('static', filename='images/bp-logo.png') }}" alt="bp">
        </div>

        <nav class="sidebar-nav">
            <a href="{{ url_for('main.dashboard') }}">
                <i class="fa-solid fa-house"></i>
                <span>Home</span>
            </a>

            <a href="{{ url_for('main.authority') }}">
                <i class="fa-solid fa-building-shield"></i>
                <span>Authority</span>
            </a>

            <a href="{{ url_for('main.calls') }}">
                <i class="fa-solid fa-phone"></i>
                <span>Calls</span>
            </a>

            <a href="{{ url_for('main.emails') }}">
                <i class="fa-solid fa-envelope"></i>
                <span>Emails</span>
            </a>

            <a href="{{ url_for('main.incidents') }}">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span>Incidents</span>
            </a>
            <a href="{{ url_for('main.media') }}">
                <i class="fa-solid fa-globe"></i>
                <span>PIO Dashboard</span>
            </a>

        </nav>
        <div class="sidebar-footer">

    <button type="button" class="theme-toggle-btn" onclick="toggleTheme()">
        <i id="themeIcon" class="fa-solid fa-moon"></i>
        <span>Theme</span>
    </button>

    <a href="{{ url_for('auth.logout') }}" class="logout-btn">
        <i class="fa-solid fa-right-from-bracket"></i>
        <span>Logout</span>
    </a>

</div>


    </aside>

    <main class="content">
        {% block content %}{% endblock %}
    </main>

</div>

<script>
function openModal(name) {
    const modal = document.getElementById("modal-" + name);
    if (!modal) return;
    modal.style.display = "flex";
    modal.style.zIndex = "9999";
}

function closeModal(name) {
    const modal = document.getElementById("modal-" + name);
    if (modal) modal.style.display = "none";
}
</script>

<script>
function openSocialDetail(
    id,
    title,
    source,
    channel,
    region,
    classification,
    urgency,
    text,
    imageSrc,
    time
) {
    const titleEl = document.getElementById("sd-title");
    const textEl = document.getElementById("sd-text");
    const metaEl = document.getElementById("sd-meta");

    if (titleEl) titleEl.innerText = title || "";
    if (textEl) textEl.innerText = text || "";
    if (metaEl) metaEl.innerText = (channel || "") + " · " + (region || "") + " · " + (source || "") + " · " + (time || "");

    const imgWrap = document.getElementById("sd-image-wrap");
    const img = document.getElementById("sd-image");

    if (imgWrap && img) {
        if (imageSrc && imageSrc.trim() !== "") {
            img.src = imageSrc;
            imgWrap.style.display = "block";
        } else {
            img.src = "";
            imgWrap.style.display = "none";
        }
    }

    openModal("socialDetail");
}

function openSocialDetailFromEl(el) {
    openSocialDetail(
        el.dataset.id || "",
        el.dataset.title || "",
        el.dataset.source || "",
        el.dataset.channel || "",
        el.dataset.region || "",
        el.dataset.classification || "",
        el.dataset.urgency || "",
        el.dataset.text || "",
        el.dataset.image || "",
        el.dataset.time || ""
    );
}
</script>

<script>
function bindImagePreview(inputId, previewId) {
    const input = document.getElementById(inputId);
    const preview = document.getElementById(previewId);
    if (!input || !preview) return;

    input.addEventListener("change", function () {
        const file = input.files && input.files[0];
        if (!file) {
            preview.src = "";
            preview.style.display = "none";
            return;
        }

        const name = (file.name || "").toLowerCase();
        const ok = name.endsWith(".jpg") || name.endsWith(".jpeg") || name.endsWith(".png");
        if (!ok) {
            input.value = "";
            preview.src = "";
            preview.style.display = "none";
            return;
        }

        preview.src = URL.createObjectURL(file);
        preview.style.display = "block";
    });
}

document.addEventListener("DOMContentLoaded", function () {
    bindImagePreview("socialImageInput", "socialImagePreview");
    bindImagePreview("newsImageInput", "newsImagePreview");
});
</script>

<script>
function setSocialFormEdit(item) {
    const form = document.getElementById("socialForm");
    const btn = document.getElementById("socialSubmitBtn");

    if (!form || !btn) return;

    form.action = "/social/" + item.id + "/edit";
    btn.textContent = "Save";

    const ch = document.getElementById("social_channel");
    const rg = document.getElementById("social_region");
    const cl = document.getElementById("social_classification");
    const ug = document.getElementById("social_urgency");
    const src = document.getElementById("social_source");
    const ttl = document.getElementById("social_title");
    const txt = document.getElementById("social_text");
    const tags = document.getElementById("social_tags");

    if (ch) ch.value = item.channel || "";
    if (rg) rg.value = item.region || "";
    if (cl) cl.value = item.classification || "";
    if (ug) ug.value = item.urgency || "";
    if (src) src.value = item.source || "";
    if (ttl) ttl.value = item.title || "";
    if (txt) txt.value = item.text || "";
    if (tags) tags.value = item.tags || "";

    const preview = document.getElementById("socialImagePreview");
    if (preview) {
        if (item.image && item.image.trim() !== "") {
            preview.src = item.image;
            preview.style.display = "block";
        } else {
            preview.src = "";
            preview.style.display = "none";
        }
    }

    const fileInput = document.getElementById("socialImageInput");
    if (fileInput) fileInput.value = "";

    openModal("social");
}

function openSocialEditFromEl(el) {
    setSocialFormEdit({
        id: el.dataset.id || "",
        channel: el.dataset.channel || "",
        region: el.dataset.region || "",
        classification: el.dataset.classification || "",
        urgency: el.dataset.urgency || "",
        source: el.dataset.source || "",
        title: el.dataset.title || "",
        text: el.dataset.text || "",
        tags: el.dataset.tags || "",
        image: el.dataset.image || ""
    });

    const preview = document.getElementById("editSocialImagePreview");
    if (el.dataset.image) {
        preview.src = el.dataset.image;
        preview.style.display = "block";
    } else {
        preview.style.display = "none";
    }

    openModal("editSocial");
}

</script>

<script>
function setNewsFormEdit(item) {
    const form = document.getElementById("newsForm");
    const btn = document.getElementById("newsSubmitBtn");

    if (!form || !btn) return;

    form.action = "/news/" + item.id + "/edit";
    btn.textContent = "Save";

    const src = document.getElementById("news_source");
    const ttl = document.getElementById("news_title");
    const txt = document.getElementById("news_text");

    if (src) src.value = item.source || "";
    if (ttl) ttl.value = item.title || "";
    if (txt) txt.value = item.text || "";

    const preview = document.getElementById("newsImagePreview");
    if (preview) {
        if (item.image && item.image.trim() !== "") {
            preview.src = item.image;
            preview.style.display = "block";
        } else {
            preview.src = "";
            preview.style.display = "none";
        }
    }

    const fileInput = document.getElementById("newsImageInput");
    if (fileInput) fileInput.value = "";

    openModal("news");
}

function openNewsEditFromEl(el) {
    setNewsFormEdit({
        id: el.dataset.id || "",
        source: el.dataset.source || "",
        title: el.dataset.title || "",
        text: el.dataset.text || "",
        image: el.dataset.image || ""
    });

    const preview = document.getElementById("editNewsImagePreview");
    if (el.dataset.image) {
        preview.src = el.dataset.image;
        preview.style.display = "block";
    } else {
        preview.style.display = "none";
    }

    openModal("editNews");
}

</script>

<script>
function updateLiveClock() {
    const now = new Date();
    const h = String(now.getHours()).padStart(2, "0");
    const m = String(now.getMinutes()).padStart(2, "0");
    const s = String(now.getSeconds()).padStart(2, "0");

    const el = document.getElementById("liveClock");
    if (el) el.textContent = h + ":" + m + ":" + s;
}

updateLiveClock();
setInterval(updateLiveClock, 1000);
</script>

<script>
let weatherIndex = 0;
let weatherNodes = [];

document.addEventListener("DOMContentLoaded", function () {
    const container = document.getElementById("weatherData");
    if (!container) return;

    weatherNodes = Array.from(container.children);
    if (weatherNodes.length === 0) return;

    weatherIndex = 0;
    renderWeather();
});

function renderWeather() {
    const el = weatherNodes[weatherIndex];
    if (!el) return;

    document.getElementById("weatherTemp").textContent =
        el.dataset.temp + "°C";

    document.getElementById("weatherFeels").textContent =
        el.dataset.feels
            ? "Feels like " + el.dataset.feels + "°C"
            : "";

    let meta = "";
    if (el.dataset.humidity) {
        meta += "<div>Humidity: " + el.dataset.humidity + "%</div>";
    }
    if (el.dataset.air) {
        meta += "<div>Air quality: " + el.dataset.air + "</div>";
    }
    document.getElementById("weatherMeta").innerHTML = meta;

    document.getElementById("weatherTime").textContent =
        "Updated " + el.dataset.time;
}

function weatherPrev() {
    if (weatherIndex < weatherNodes.length - 1) {
        weatherIndex++;
        renderWeather();
    }
}

function weatherNext() {
    if (weatherIndex > 0) {
        weatherIndex--;
        renderWeather();
    }
}
</script>

<script>
let timerInterval = null;
let timerSound = null;

function renderDbTimer() {
    const countdownEl = document.getElementById("timerCountdown");
    const activeEl = document.getElementById("timerActive");
    const emptyEl = document.getElementById("timerEmpty");
    const alertEl = document.getElementById("timerAlert");

    if (!countdownEl) return;

    let remaining = parseInt(countdownEl.dataset.remaining, 10);
    if (isNaN(remaining) || remaining <= 0) return;

    emptyEl.style.display = "none";
    activeEl.style.display = "block";

    if (!timerSound) {
        timerSound = new Audio("/static/sounds/alert.mp3");
        timerSound.loop = true;
    }

    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
        if (remaining <= 0) {
            countdownEl.innerText = "00:00";
            alertEl.style.display = "block";
            countdownEl.classList.add("expired");
            timerSound.play();
            clearInterval(timerInterval);
            timerInterval = null;
            return;
        }

        const m = Math.floor(remaining / 60);
        const s = remaining % 60;

        countdownEl.innerText =
            String(m).padStart(2, "0") + ":" +
            String(s).padStart(2, "0");

        remaining -= 1;
    }, 1000);
}

document.addEventListener("DOMContentLoaded", renderDbTimer);
</script>



<script>
function toggleTheme() {
    const body = document.body;
    const icon = document.getElementById("themeIcon");

    if (body.getAttribute("data-theme") === "dark") {
        body.removeAttribute("data-theme");
        icon.classList.remove("fa-sun");
        icon.classList.add("fa-moon");
    } else {
        body.setAttribute("data-theme", "dark");
        icon.classList.remove("fa-moon");
        icon.classList.add("fa-sun");
    }
}
</script>

<script>
function openActionEdit(el) {
    const form = document.getElementById("actionEditForm");

    document.getElementById("edit_action").value = el.dataset.action || "";
    document.getElementById("edit_description").value = el.dataset.description || "";
    document.getElementById("edit_owner").value = el.dataset.owner || "";
    document.getElementById("edit_stakeholder").value = el.dataset.stakeholder || "";
    document.getElementById("edit_status").value = el.dataset.status || "none";

    form.action = "/actions/" + el.dataset.id + "/edit";
    openModal("action-edit");
}
</script>



</body>
</html>
